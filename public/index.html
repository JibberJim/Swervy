<html><title>Steer</title>
<body>
<script type='text/javascript'>
let timer = 0;
async function postAngle(angle) {
  clearTimeout(timer);
  if (document.getElementById("on").checked) {
    document.getElementById('debug').textContent="Sending:"+angle+"\n"+document.getElementById('debug').textContent.substring(0,200);
    const r = await fetch('/steer', {
      method:'post',
      headers:{ 'Accept':'application/json','Content-Type':'application/json' },
      body: JSON.stringify( { steering_angle: angle } )
    } );
    let result = await r.json();
    if (!document.getElementById("usegyro").checked) {
      // if we're on send an angle every 3 seconds to keep the
      // connection open
      timer = setTimeout(postAngle,3000,0);
    }
  }
}
const options = { frequency: 1, referenceFrame: 'device' };
const sensor = new AbsoluteOrientationSensor(options);
sensor.addEventListener('reading', () => {
    if (document.getElementById("usegyro").checked) {
      let qw=sensor.quaternion[0];
      let qx=sensor.quaternion[1];
      let qy=sensor.quaternion[2];
      let qz=sensor.quaternion[3];
      let heading = Math.atan2(2*qy*qw-2*qx*qz , 1 - 2*qy*qy - 2*qz*qz);
      let degreesHeading = heading / Math.PI * 180;
      let delta =180 -  Math.abs(degreesHeading);
      let direction = heading<0 ? 1 : -1;
      if (delta<5) {
        // Make sure we don't swerve down the road when sprinting, and
        // ensure not too much effort to hold a steady course.
        delta = 0;
      }
      if (delta>45) {
        // apparently 45 is the maximum?
        delta = 45;
      }
      // XXX should we make the other steering more discrete chunks?
      console.log(heading,degreesHeading,direction);
      document.getElementById('a').textContent=direction*Math.round(delta);
      postAngle(direction*delta);
    }
});

Promise.all([navigator.permissions.query({ name: "accelerometer" }),
             navigator.permissions.query({ name: "magnetometer" }),
             navigator.permissions.query({ name: "gyroscope" })])
       .then(results => {
         if (results.every(result => result.state === "granted")) {
           sensor.start();
           document.getElementById('debug').textContent+="Starting";
         } else {
           document.getElementById('debug').textContent+="No permissions to use AbsoluteOrientationSensor.";
         }
   });



</script>
<style type="text/css">

section { font-size:4em; }
input[type=checkbox] { height:4em; width:4em; }
button { font-size:1.5em; margin:0.1em;}

</style>
<section id="main">
<input type="checkbox" id="usegyro" checked><label for="usegyro">Use Gyro</label>
<div id="buttons">
<button onclick='postAngle(-22.5)'>3</button><button onclick='postAngle(-15)'>2</button><button onclick='postAngle(-7.5)'>1</button><button onclick='postAngle(0)'>&nbsp;0&nbsp;</button><button onclick='postAngle(7.5)'>1</button><button onclick='postAngle(15)'>2</button><button onclick='postAngle(22.5)'>3</button></div>
<input type="checkbox" id="on" checked><label for="usegyro">On</label>
</section>

<div id="a"></div>
<pre id="debug"></pre>
